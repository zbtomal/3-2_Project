<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Profile Loading - JSTACK</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-box { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        button { margin: 5px; padding: 10px; background: #1f4a40; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .status { margin: 10px 0; padding: 10px; background: white; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Test Profile Loading</h1>
    
    <div class="test-box">
        <h3>Profile Loading Test</h3>
        <button onclick="testProfileLoading()">Test Profile Loading</button>
        <button onclick="checkCurrentState()">Check Current State</button>
        <button onclick="goToDashboard()">Go to Dashboard</button>
        <div id="testStatus">Click buttons to test</div>
    </div>
    
    <div class="test-box">
        <h3>Test Results</h3>
        <div id="testResults">No tests run yet</div>
    </div>

    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="auth.js"></script>
    <script type="module">
        // Wait for auth manager to be ready
        function waitForAuthManager() {
            return new Promise((resolve) => {
                const checkAuthManager = () => {
                    if (window.authManager) {
                        console.log('Auth manager is ready');
                        resolve();
                    } else {
                        console.log('Auth manager not ready, waiting...');
                        setTimeout(checkAuthManager, 100);
                    }
                };
                checkAuthManager();
            });
        }
        
        // Test profile loading
        window.testProfileLoading = async function() {
            const status = document.getElementById('testStatus');
            const results = document.getElementById('testResults');
            
            status.innerHTML = 'Testing profile loading...';
            results.innerHTML = '';
            
            try {
                await waitForAuthManager();
                
                const step1 = document.createElement('div');
                step1.className = 'status';
                step1.innerHTML = '<strong>Step 1:</strong> Checking auth state...';
                results.appendChild(step1);
                
                const isLoggedIn = window.authManager.isLoggedIn();
                const currentUser = window.authManager.getCurrentUser();
                
                if (isLoggedIn && currentUser) {
                    step1.innerHTML = '<strong>Step 1:</strong> ✅ User is logged in: ' + currentUser.email;
                    
                    const step2 = document.createElement('div');
                    step2.className = 'status';
                    step2.innerHTML = '<strong>Step 2:</strong> Checking profile...';
                    results.appendChild(step2);
                    
                    let profile = window.authManager.getUserProfile();
                    if (profile) {
                        step2.innerHTML = '<strong>Step 2:</strong> ✅ Profile already loaded: ' + profile.userType;
                    } else {
                        step2.innerHTML = '<strong>Step 2:</strong> ❌ Profile not loaded, trying to load...';
                        
                        const step3 = document.createElement('div');
                        step3.className = 'status';
                        step3.innerHTML = '<strong>Step 3:</strong> Loading profile...';
                        results.appendChild(step3);
                        
                        profile = await window.authManager.ensureProfileLoaded();
                        if (profile) {
                            step3.innerHTML = '<strong>Step 3:</strong> ✅ Profile loaded successfully: ' + profile.userType;
                        } else {
                            step3.innerHTML = '<strong>Step 3:</strong> ❌ Failed to load profile';
                        }
                    }
                    
                    status.innerHTML = '<span class="success">✅ Profile loading test completed!</span>';
                } else {
                    step1.innerHTML = '<strong>Step 1:</strong> ❌ User is not logged in';
                    status.innerHTML = '<span class="error">❌ Please login first</span>';
                }
            } catch (error) {
                status.innerHTML = '<span class="error">❌ Error: ' + error.message + '</span>';
            }
        };
        
        // Check current state
        window.checkCurrentState = async function() {
            const status = document.getElementById('testStatus');
            const results = document.getElementById('testResults');
            
            status.innerHTML = 'Checking current state...';
            results.innerHTML = '';
            
            try {
                await waitForAuthManager();
                
                const authManager = window.authManager;
                const isLoggedIn = authManager.isLoggedIn();
                const currentUser = authManager.getCurrentUser();
                const profile = authManager.getUserProfile();
                
                const stateDiv = document.createElement('div');
                stateDiv.className = 'status';
                stateDiv.innerHTML = `
                    <strong>Current State:</strong><br>
                    - Logged In: ${isLoggedIn}<br>
                    - Current User: ${currentUser ? currentUser.email : 'None'}<br>
                    - User UID: ${currentUser ? currentUser.uid : 'None'}<br>
                    - Profile Loaded: ${profile ? 'Yes' : 'No'}<br>
                    - Profile Type: ${profile ? profile.userType : 'None'}<br>
                    - Profile Name: ${profile ? profile.name : 'None'}
                `;
                results.appendChild(stateDiv);
                
                status.innerHTML = '<span class="success">✅ State checked!</span>';
            } catch (error) {
                status.innerHTML = '<span class="error">❌ Error: ' + error.message + '</span>';
            }
        };
        
        // Go to dashboard
        window.goToDashboard = async function() {
            const status = document.getElementById('testStatus');
            
            try {
                await waitForAuthManager();
                
                const isLoggedIn = window.authManager.isLoggedIn();
                const profile = window.authManager.getUserProfile();
                
                if (!isLoggedIn) {
                    status.innerHTML = '<span class="error">❌ Not logged in. Please login first.</span>';
                    return;
                }
                
                if (!profile) {
                    status.innerHTML = '<span class="error">❌ No profile loaded. This will cause dashboard issues.</span>';
                    return;
                }
                
                status.innerHTML = '<span class="success">✅ Navigating to dashboard...</span>';
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1000);
            } catch (error) {
                status.innerHTML = '<span class="error">❌ Error: ' + error.message + '</span>';
            }
        };
        
        console.log('Test profile page loaded');
    </script>
</body>
</html> 
<!DOCTYPE html>
<html>
<head>
  <title>Browse Jobs</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; }
    .container { max-width: 800px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.08); }
    h2 { text-align: center; color: #263238; }
    .job-list { margin-top: 30px; }
    .job-item { border-bottom: 1px solid #eee; padding: 18px 0; }
    .job-item:last-child { border-bottom: none; }
    .job-title { font-size: 20px; color: #0277bd; margin-bottom: 6px; }
    .job-category { font-size: 14px; color: #555; margin-bottom: 4px; }
    .job-salary { font-size: 15px; color: #388e3c; margin-bottom: 4px; }
    .job-desc { color: #333; }
    .no-jobs { text-align: center; color: #888; margin-top: 40px; }
    .apply-btn { background: #1f4a40; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    .apply-btn:hover { background: #0277bd; }
    .loading { text-align: center; color: #888; margin-top: 40px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Browse Jobs</h2>
    <div class="job-list" id="jobList">
      <div class="loading">Loading jobs...</div>
    </div>
  </div>

  <script type="module" src="../firebase-config.js"></script>
  <script type="module" src="../auth.js"></script>
  <script type="module">
    // Load jobs from Firebase
    async function loadJobs() {
      try {
        const jobsSnapshot = await getDocs(collection(db, "jobs"));
        const jobs = [];
        jobsSnapshot.forEach((doc) => {
          const jobData = doc.data();
          if (!jobData.deleted) { // Only show non-deleted jobs
            jobs.push({ id: doc.id, ...jobData });
          }
        });

        const jobList = document.getElementById('jobList');
        
        if (jobs.length === 0) {
          jobList.innerHTML = '<div class="no-jobs">No jobs found.</div>';
          return;
        }

        jobList.innerHTML = jobs.map(job => `
          <div class="job-item">
            <div class="job-title">${job.title}</div>
            <div class="job-category">Category: ${job.category}</div>
            <div class="job-salary">Salary: ${job.salary}</div>
            <div class="job-desc">${job.description}</div>
            ${window.authManager && window.authManager.isLoggedIn() && window.authManager.getUserProfile()?.userType === 'employee' ? 
              `<button class="apply-btn" onclick="applyForJob('${job.id}')">Apply</button>` : 
              '<p><em>Please <a href="../loginpage.html">login</a> as an employee to apply for jobs.</em></p>'
            }
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading jobs:', error);
        document.getElementById('jobList').innerHTML = '<div class="no-jobs">Error loading jobs.</div>';
      }
    }

    // Apply for job function
    window.applyForJob = async function(jobId) {
      if (!window.authManager || !window.authManager.isLoggedIn()) {
        alert('Please login to apply for jobs.');
        return;
      }

      try {
        // Get job details
        const jobDoc = await getDoc(doc(db, "jobs", jobId));
        if (!jobDoc.exists()) {
          alert('Job not found.');
          return;
        }

        const jobData = jobDoc.data();
        const currentUser = window.authManager.getCurrentUser();
        const userProfile = window.authManager.getUserProfile();
        
        // Check if already applied
        const existingApplication = await getDocs(
          query(collection(db, "applications"), 
            where("jobId", "==", jobId),
            where("employeeId", "==", currentUser.uid))
        );

        if (!existingApplication.empty) {
          alert('You have already applied for this job.');
          return;
        }

        // Create application
        const applicationData = {
          jobId: jobId,
          jobTitle: jobData.title,
          employeeId: currentUser.uid,
          employeeName: userProfile.name,
          employeeEmail: currentUser.email,
          status: 'pending',
          appliedAt: new Date()
        };

        await addDoc(collection(db, "applications"), applicationData);
        alert('Application submitted successfully!');
      } catch (error) {
        console.error('Error applying for job:', error);
        alert('Error applying for job. Please try again.');
      }
    };

    // Load jobs when page loads
    document.addEventListener('DOMContentLoaded', loadJobs);
  </script>
</body>
</html>
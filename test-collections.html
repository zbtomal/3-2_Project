<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Collections - JSTACK</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-box { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { margin: 5px; padding: 10px; background: #1f4a40; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .collection-info { background: #fff; padding: 10px; margin: 5px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Test Firestore Collections</h1>
    
    <div class="test-box">
        <h3>Test Registration and Collections</h3>
        <button onclick="testEmployerRegistration()">Register Test Employer</button>
        <button onclick="testEmployeeRegistration()">Register Test Employee</button>
        <button onclick="checkCollections()">Check All Collections</button>
        <div id="testStatus">Click buttons to test</div>
    </div>
    
    <div class="test-box">
        <h3>Collection Status</h3>
        <div id="collectionStatus">Click "Check All Collections" to see status</div>
    </div>

    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCnuedaZrRn7Zpx1SrDFs53jMYvxzfNOyo",
            authDomain: "freelance-f5e40.firebaseapp.com",
            projectId: "freelance-f5e40",
            storageBucket: "freelance-f5e40.firebasestorage.app",
            messagingSenderId: "1048409804135",
            appId: "1:1048409804135:web:38beba66fdab0f4beef3c2",
            measurementId: "G-S9934VZEY7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // AuthManager class for testing
        class TestAuthManager {
            constructor() {
                this.currentUser = null;
                this.userProfile = null;
            }

            async registerUser(email, password, userData) {
                try {
                    console.log("Starting registration for:", email);
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    console.log("User created, saving profile to Firestore...");
                    
                    // Determine which collection to save to based on user type
                    const collectionName = userData.userType === 'employer' ? 'employers' : 'employees';
                    
                    // Save additional user data to Firestore
                    const userDocRef = await addDoc(collection(db, collectionName), {
                        uid: user.uid,
                        email: email,
                        name: userData.name,
                        phone: userData.phone,
                        userType: userData.userType,
                        createdAt: new Date(),
                        ...userData
                    });
                    
                    console.log(`Profile saved to ${collectionName} collection with ID:`, userDocRef.id);
                    
                    // Also save to users collection for general access
                    await addDoc(collection(db, "users"), {
                        uid: user.uid,
                        email: email,
                        name: userData.name,
                        phone: userData.phone,
                        userType: userData.userType,
                        createdAt: new Date(),
                        ...userData
                    });
                    
                    console.log("Profile also saved to users collection");
                    
                    return { success: true, user };
                } catch (error) {
                    console.error("Registration error:", error);
                    return { success: false, error: error.message };
                }
            }
        }

        // Initialize test auth manager
        const testAuthManager = new TestAuthManager();
        let testUsers = [];
        
        // Test employer registration
        window.testEmployerRegistration = async function() {
            const status = document.getElementById('testStatus');
            status.innerHTML = 'Registering test employer...';
            
            try {
                const testEmail = `employer${Date.now()}@example.com`;
                const userData = {
                    name: 'Test Employer',
                    phone: '1234567890',
                    userType: 'employer'
                };
                
                const result = await testAuthManager.registerUser(testEmail, 'password123', userData);
                
                if (result.success) {
                    testUsers.push({ type: 'employer', user: result.user });
                    status.innerHTML = '<span class="success">✅ Employer registered successfully! Email: ' + testEmail + '</span>';
                } else {
                    status.innerHTML = '<span class="error">❌ Employer registration failed: ' + result.error + '</span>';
                }
            } catch (error) {
                status.innerHTML = '<span class="error">❌ Error: ' + error.message + '</span>';
            }
        };
        
        // Test employee registration
        window.testEmployeeRegistration = async function() {
            const status = document.getElementById('testStatus');
            status.innerHTML = 'Registering test employee...';
            
            try {
                const testEmail = `employee${Date.now()}@example.com`;
                const userData = {
                    name: 'Test Employee',
                    phone: '0987654321',
                    userType: 'employee'
                };
                
                const result = await testAuthManager.registerUser(testEmail, 'password123', userData);
                
                if (result.success) {
                    testUsers.push({ type: 'employee', user: result.user });
                    status.innerHTML = '<span class="success">✅ Employee registered successfully! Email: ' + testEmail + '</span>';
                } else {
                    status.innerHTML = '<span class="error">❌ Employee registration failed: ' + result.error + '</span>';
                }
            } catch (error) {
                status.innerHTML = '<span class="error">❌ Error: ' + error.message + '</span>';
            }
        };
        
        // Check all collections
        window.checkCollections = async function() {
            const status = document.getElementById('collectionStatus');
            status.innerHTML = 'Checking collections...';
            
            try {
                const collections = ['users', 'employers', 'employees'];
                let results = '';
                
                for (const collectionName of collections) {
                    try {
                        const querySnapshot = await getDocs(collection(db, collectionName));
                        const count = querySnapshot.size;
                        const docs = [];
                        querySnapshot.forEach((doc) => {
                            docs.push({ id: doc.id, ...doc.data() });
                        });
                        
                        results += `
                            <div class="collection-info">
                                <strong>${collectionName.toUpperCase()} Collection:</strong> ${count} documents
                                <br><small>Documents: ${JSON.stringify(docs, null, 2)}</small>
                            </div>
                        `;
                    } catch (error) {
                        results += `
                            <div class="collection-info error">
                                <strong>${collectionName.toUpperCase()} Collection:</strong> Error - ${error.message}
                            </div>
                        `;
                    }
                }
                
                status.innerHTML = results;
            } catch (error) {
                status.innerHTML = '<span class="error">❌ Error checking collections: ' + error.message + '</span>';
            }
        };
        
        console.log('Test collections page loaded with Firebase imports');
    </script>
</body>
</html> 